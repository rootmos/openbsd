name: Run tests
on:
  push:
    branches:
      - main

jobs:
  sanity-example:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository code
      uses: actions/checkout@v4

    - name: The example's specification is clean
      run: scripts/is-clean example/openbsd.toml

  sanity-script:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.18.4
    steps:
    - name: Install essentials
      run: apk add python3

    - name: Check out repository code
      uses: actions/checkout@v4

    - name: Script is footloose and fancy-free
      run: scripts/load_module.py openbsd

  base:
    needs:
      - sanity-script
    strategy:
      matrix:
        version: [ 7.3, 7.4 ]
        arch: [ amd64, i386 ]
    runs-on: ubuntu-latest
    container:
      image: alpine:3.18.4
    env:
      OPENBSD_CACHE: /tmp/cache
      WORKDIR: /${{github.job}}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}
    steps:
    - name: Install essentials
      run: apk add bash python3 tar

    - name: Check out repository code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: ./openbsd deps --install --arch=${{ matrix.arch }}

    - name: Cache OpenBSD files
      id: cache-openbsd
      uses: actions/cache@v3
      with:
          path: ${{ env.OPENBSD_CACHE }}
          key: openbsd-${{ matrix.version }}-${{ matrix.arch }}-${{ github.job }}
          restore-keys: |
              openbsd-${{ matrix.version }}-${{ matrix.arch }}-${{ github.job }}
              openbsd-${{ matrix.version }}-${{ matrix.arch }}
              openbsd-${{ matrix.version }}
              openbsd

    - name: Run test
      run: tests/base -v ${{ matrix.version }} -a ${{ matrix.arch }}

    - name: Keep artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ${{ github.job }}-${{ matrix.version }}-${{ matrix.arch }}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}
        retention-days: 3
        path: /${{github.job}}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}/**/*

  example:
    needs:
      - base
      - sanity-script
      - sanity-example
    strategy:
      matrix:
        version: [ 7.4 ]
        arch: [ amd64 ]
    runs-on: ubuntu-latest
    env:
      OPENBSD_CACHE: /tmp/cache
      WORKDIR: /${{github.job}}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}
    container:
      image: alpine:3.18.4

    steps:
    - name: Install essentials
      run: apk add bash python3 tar

    - name: Check out repository code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: ./openbsd deps --install --arch=${{ matrix.arch }}

    - name: Cache OpenBSD files
      id: cache-openbsd
      uses: actions/cache@v3
      with:
          path: ${{ env.OPENBSD_CACHE }}
          key: openbsd-${{ matrix.version }}-${{ matrix.arch }}-${{ github.job }}
          restore-keys: |
              openbsd-${{ matrix.version }}-${{ matrix.arch }}-${{ github.job }}
              openbsd-${{ matrix.version }}-${{ matrix.arch }}
              openbsd-${{ matrix.version }}
              openbsd

    - name: Run test
      run: tests/example -v ${{ matrix.version }} -a ${{ matrix.arch }}

    - name: Keep artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ${{ github.job }}-${{ matrix.version }}-${{ matrix.arch }}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}
        retention-days: 3
        path: /${{github.job}}-${{github.run_id}}-${{github.run_number}}-${{github.run_attempt}}/**/*
